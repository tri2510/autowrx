# Copyright (c) 2025 Eclipse Foundation.
#
# This program and the accompanying materials are made available under the
# terms of the MIT License which is available at
# https://opensource.org/licenses/MIT.
#
# SPDX-License-Identifier: MIT

# AutoWRX Production Deployment
# Usage:
#   docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

services:
  # AutoWRX - Backend serves both API and frontend static files
  autowrx:
    platform: linux/amd64
    container_name: ${ENV:-prod}-autowrx
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    image: ghcr.io/${GITHUB_REPOSITORY:-eclipse-autowrx/autowrx}/autowrx:${IMAGE_TAG:-latest}
    ports:
      - "${FRONTEND_PORT:-3200}:3200"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3200}
      # Always use port 27017 for internal Docker network communication
      # MONGODB_PORT (27010) is only for external host access
      MONGODB_URL: mongodb://autowrx-db:27017/${MONGODB_DATABASE:-autowrx}
      JWT_SECRET: ${JWT_SECRET}
      STRICT_AUTH: ${STRICT_AUTH:-true}
      JWT_COOKIE_NAME: ${JWT_COOKIE_NAME:-token}
      CORS_ORIGINS: ${CORS_ORIGINS}
      ADMIN_EMAILS: ${ADMIN_EMAILS}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - '${UPLOAD_PATH_HOST:-./data/upload}:/opt/data/upload'
    depends_on:
      autowrx-db:
        condition: service_healthy
    networks:
      - autowrx-network
    restart: always

  # MongoDB - Database
  autowrx-db:
    platform: linux/amd64
    container_name: ${ENV:-prod}-autowrx-db
    image: mongo:4.4.6-bionic
    ports:
      - "${MONGODB_PORT:-27010}:27017"
    volumes:
      - autowrx-dbdata:/data/db
    networks:
      - autowrx-network
    restart: always
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

volumes:
  autowrx-dbdata:
    name: ${ENV:-prod}-autowrx-dbdata

networks:
  autowrx-network:
    name: ${ENV:-prod}-autowrx-network
    driver: bridge

