# Nginx configuration for prostep.digitalauto.tech
# This config improves proxy headers and static file handling

# HTTPS Server Block
server {
    listen 443 ssl http2;
    server_name prostep.digitalauto.tech prostep.digital.auto;
    
    # SSL configuration (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/prostep.digitalauto.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/prostep.digitalauto.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Increase buffer sizes for large static files
    client_max_body_size 50M;
    client_body_buffer_size 128k;
    
    # Proxy buffer settings
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    location / {
        # Essential proxy headers for Express behind Nginx
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Disable redirect handling - let Express handle it
        proxy_redirect off;
        
        # Use HTTP/1.1 for better compatibility
        proxy_http_version 1.1;
        
        # Pass the original request
        proxy_pass http://localhost:3200;
        
        # Disable buffering for streaming responses (optional, can help with large files)
        # proxy_buffering off;
    }

    # Optional: Cache static assets directly in Nginx to improve performance
    # Uncomment if you want Nginx to cache static files
    # location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
    #     proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=static_cache:10m max_size=100m inactive=60m;
    #     proxy_cache static_cache;
    #     proxy_cache_valid 200 60m;
    #     proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    #     proxy_cache_lock on;
    #     
    #     proxy_set_header Host $http_host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_pass http://localhost:3200;
    #     add_header X-Cache-Status $upstream_cache_status;
    # }
}

# HTTP to HTTPS Redirect (managed by Certbot)
server {
    if ($host = prostep.digitalauto.tech) {
        return 301 https://$host$request_uri;
    }
    # managed by Certbot
    listen 80;
    server_name prostep.digitalauto.tech prostep.digital.auto;
    return 404; # managed by Certbot
}

